/*
 * Ce fichier défini tout les paramètres du système de déploiement des parachutes de la fusée.
 */

#ifndef _configCircuitDeploiement_h
#define _configCircuitDeploiement_h

//  Hardware pinout
/* BMP180 -> Arduino Nano
 * -      -> GND
 * +      -> VCC (3.3V)
 * IO     -> Non Connecté
 */
#define IO_BMP180_DA A4
#define IO_BMP180_CL A5

/* SD BOARD -> Arduino Nano
 * CD       -> Non Connecté
 * GND      -> GND
 * VCC      -> VCC (3.3V)
 * DO		-> 12
 * DI		-> 11
 * CS		-> 10
 * SCK		-> 13
 */
#define IO_SD_DO 12
#define IO_SD_SCK 13
#define IO_SD_DI 11
#define IO_SD_CS 10
// Buzzer
#define IO_BUZZER_OUT 3
// Parachutes
// Sortie du signal de déploiement du drogue
#define IO_DROGUE_CTRL 5
// Sortie du signal de déploiement du main
#define IO_MAIN_CTRL 6
// Entrée vérifiant la continuité de l'alumette du drogue
#define IO_DROGUE_STATE 7
// Entrée vérifiant la continuité de l'alumette du main
#define IO_MAIN_STATE 8
//  Altimeter
#define ALTIMETER_INVALID_ALTITUDE_TOLERANCE 1000.0
// paramètres log unit
#define LOG_UNIT_SERIAL_BAUDRATE 115200
#define LOG_UNIT_FILE_NAME "alt"
#define LOG_UNIT_MAX_NB_OF_FILES 99
#define LOG_UNIT_FILE_EXT ".csv"
// Messages d'évènements
#define MESSAGE_BURNOUT_STARTED "burnout started"
#define MESSAGE_BURNOUT_FINISHED "burnout finished"
#define MESSAGE_DROGUE_OUT "drogue out"
#define MESSAGE_DROGUE_ALREADY_OUT "drogue already out"
#define MESSAGE_MAIN_OUT "main out"
#define MESSAGE_MAIN_ALREADY_OUT "main already out"
#define MESSAGE_FLIGHT_FINISHED "flight finished"
#define MESSAGE_INVALID_ALTITUDE "invalid altitude"
// Format du fichier log
#define ID_LOG_MESSAGE 0   //chiffre qui va avoir au début de chaque ligne du header qui est un message d'information
#define ID_LOG_DATA 1   //chiffre qui va avoir au début de chaque ligne qui est du data
#define ID_LOG_EVENT 2   //chiffre qui va avoir au début de chaque ligne du header qui est un evenement
// Paramètres du buzzer
#define BUZZER_TIME_BETWEEN_SEQUENCES {{ buzzer_time_between_sequences }}
#define BUZZER_CYCLE_DURATION {{ buzzer_cycle_duration }}
// Id des parachutes
#define ID_PARACHUTE_DROGUE 0
#define ID_PARACHUTE_MAIN 1
// Tag de l'état des parachutes
#define TAG_PARACHUTE_NULL 0
#define TAG_PARACHUTE_DROGUE_ONLY 1
#define TAG_PARACHUTE_MAIN_ONLY 2
#define TAG_PARACHUTE_BOTH 3

//----------------------------------------------------------------------------
// Low pass filter's parameters
/*
 * The filter used is an elliptical low pass filter. The equation was computed
 * using Matlab's Ellip(() function)
 *
 * The filter's parameters are:
 *     N   = 3;        filter order
 *     Wp  = 0.1;      cutoff frequency
 *     Rp  = 0.05;     Peak-to-peak ripple
 *     Rst = 40;       Stopband attenuation
 *
 * The filter's equation is:
 *    A0*y[n] = B0*x[n] + B1*x[n-1] + B2*x[n-2] + B3*x[n-3] - A1*y[n-1] - A2*y[n-2] - A3*y[n-3]
 */

#define ALTITUDE_FILTER_ORDER {{ altitude_filter_order }}
#define ALTITUDE_ARRAY_SIZE (ALTITUDE_FILTER_ORDER + 1)

const float A[ALTITUDE_ARRAY_SIZE] = {
	1,                    // A0
	-2.242002473393440,   // A1
	1.789446106565067,    // A2
	-0.495145905738350    // A3
};

const float B[ALTITUDE_ARRAY_SIZE] = {
	0.019249185590260,    // B0
	0.006899678126378,    // B1
	0.006899678126378,    // B2
	0.019249185590260     // B3
};


//----------------------------------------------------------------------------
//  Paramètres de la boucle principale

// Fréquence d'échantillonage des données en micro-secondes
#define DATA_SAMPLING_PERIOD {{ data_sampling_period }}

//----------------------------------------------------------------------------
// Breakpoint d'altitude (m) et de vitessse (m/ech) ou un échantillon est 0,1 s
#define BREAKPOINT_SPEED_TO_BURNOUT {{ '%0.4f' % (breakpoint_speed_to_burnout *
	(data_sampling_period / 1000000.0)) | float }}
#define BREAKPOINT_SPEED_TO_PRE_DROGUE {{ '%0.4f' % (breakpoint_speed_to_pre_drogue *
	(data_sampling_period / 1000000.0)) | float }}
#define BREAKPOINT_SPEED_TO_IDLE {{ '%0.4f' % (breakpoint_speed_to_idle *
	(data_sampling_period / 1000000.0)) | float }}

#define BREAKPOINT_ALTITUDE_TO_BURNOUT {{ breakpoint_altitude_to_burnout }}
#define BREAKPOINT_ALTITUDE_TO_DRIFT {{ breakpoint_altitude_to_drift }}
// Breakpoint du nombre d'échantillion d'altitude entre l'apogée et le déploiement du drogue.
#define BREAKPOINT_DELTA_TIME_APOGEE {{ breakpoint_delta_time_apogee }}

// Range d'altitude prévu
#define FLIGHT_MINIMAL_ALTITUDE {{ flight_minimal_altitude }}
#define FLIGHT_MAXIMAL_ALTITUDE {{ flight_maximal_alitude }}

#endif
